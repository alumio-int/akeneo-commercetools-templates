{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"scheduler-entry","identifier":"akeneo-fetch-categories","name":"Akeneo - Fetch - Categories","object":{"parameters":{"job":[{"prototype":"run-incoming","parameters":{"incoming":"akeneo-fetch-categories"}}],"handlers":[],"priority":2,"expression":"*/15 * * * *"}},"description":"We need to get all categories from Akeneo system to ensure the parent children relation can be sent in the right order. To do so, we use an Incoming **\"Akeneo - Fetch - Categories\"** to get data from Akeneo Server.","owner":null,"disabled":true}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"incoming-configuration","identifier":"akeneo-fetch-categories","name":"Akeneo - Fetch - Categories","object":{"parameters":{"entityType":"base-category","subscriber":{"prototype":"http-subscriber","parameters":{"client":"akeneo-http-client","request":{"uri":"/api/rest/v1/categories","payload":[],"plugins":[],"payloadType":"data","authentications":[]},"pagination":{"prototype":"next","parameters":{"pattern":"_links.next","pageLimit":1000}},"deserializer":{"prototype":"json","parameters":{"pattern":"_embedded.items","readMethod":"wholeFile","encodeInput":false}}}},"transformers":["akeneo-prepare-convert-labels-to-localizations","akeneo-convert-category-to-alumio-base","akeneo-filter-category"]}},"description":"We need to get all categories from Akeneo system to ensure the parent children relation can be sent in the right order. To do so, we use an Incoming **\"Akeneo - Fetch - Categories\"** to get data from Akeneo Server.\n\nThis incoming will create a task inside Alumio with data structured as Alumio base categories.","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"http-client","identifier":"akeneo-http-client","name":"Akeneo - HTTP Client","object":{"prototype":"akeneo-http-client-v2","parameters":{"key":"","baseUri":"${AKENEO_BASE_URL}","advanced":[],"clientId":"${AKENEO_CLIENT_ID}","password":"${AKENEO_PASSWORD}","username":"${AKENEO_USERNAME}","clientSecret":"${AKENEO_CLIENT_SECRET}","enableLogging":true,"loggerFormatter":"full"}},"description":"","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"entity","identifier":"base-category","name":"Base - Category","object":{"parameters":{"schema":[],"identifierPath":["code"]}},"description":"","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"list-transformer","identifier":"akeneo-prepare-convert-labels-to-localizations","name":"Akeneo - Prepare convert - Labels - To localizations","object":{"prototype":"data","parameters":{"filters":[],"transformers":[{"meta":[],"prototype":"accessor-move","parameters":{"source":{"prototype":"key","parameters":{"keys":[],"root":"labels"}},"destination":{"prototype":"structure","parameters":{"key":"localeCode","keys":[],"root":"localizations","value":"translation"}},"stripEnclosures":true}},{"meta":[],"prototype":"value-remover","parameters":{"patterns":[{"key":"labels"}]}}]}},"description":"Change labels from Akeneo into Alumio Base localizations","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"list-transformer","identifier":"akeneo-convert-category-to-alumio-base","name":"Akeneo - Convert - Category - To Alumio Base","object":{"prototype":"chain","parameters":{"transformers":[{"meta":[],"prototype":"data","parameters":{"filters":[],"transformers":[{"meta":[],"prototype":"value-remover","parameters":{"patterns":[{"key":"_links"},{"key":"updated"}]}}]}}]}},"description":"This is the transformer to convert the whole category data into Alumio Base data.","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"list-transformer","identifier":"akeneo-filter-category","name":"Akeneo - Filter previous - Category","object":{"meta":[],"prototype":"chain","parameters":{"transformers":[{"meta":[],"prototype":"type-setter","parameters":{"entityType":"base-category"}},{"meta":[],"prototype":"storage-filter-stored-entity","parameters":{"storage":"akeneo-filter-categories","addEntityToStorage":true}}]}},"description":"We use this transformer to filter previously created into task categories to avoid duplication.","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"storage","identifier":"akeneo-filter-categories","name":"Akeneo - Filter previous - Categories","object":{"parameters":{"path":"akeneo-filter-categories-01JVP5CHNHJFASCVZH85EGDPV1","logger":{"parameters":{"actions":[]}}}},"description":"","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"scheduler-entry","identifier":"commercetools-send-categories","name":"CommerceTools - Send - Categories","object":{"parameters":{"job":[{"prototype":"run-incoming","parameters":{"incoming":"commercetools-fetch-categories"}},{"prototype":"run-outgoing","parameters":{"route":"synchronize-categories-from-akeneo-into-commercetools"}}],"handlers":[],"priority":2,"expression":"*/15 * * * *"}},"description":"The task that was created through Incoming **\"Akeneo - Fetch - Categories\"** will then processed further by the Route **\"Synchronize Categories - From Akeneo into CommerceTools\"** and will be send using the Outgoing **\"CommerceTools - Send - Category\"**.","owner":null,"disabled":true}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"incoming-configuration","identifier":"commercetools-fetch-categories","name":"CommerceTools - Fetch - Categories","object":{"parameters":{"subscriber":{"prototype":"http-subscriber","parameters":{"client":"commercetools-http-client","request":{"uri":"/categories","payload":{"limit":500,"offset":0},"plugins":[],"serializer":{"prototype":"json","parameters":[]},"payloadType":"data","authentications":[]},"pagination":{"prototype":"query-page-parameter","parameters":{"mode":"offset","pageLimit":10000,"parameter":"offset"}},"deserializer":{"prototype":"json","parameters":{"pattern":"results","readMethod":"wholeFile","encodeInput":false}}}},"transformers":["commercetools-update-storage-category"]}},"description":"Fetch categories from Commercetools to Alumio storage","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"http-client","identifier":"commercetools-http-client","name":"Commercetools - HTTP Client","object":{"prototype":"commercetools-http-client","parameters":{"key":"","scope":"manage_project:le-alumio","authUrl":"https://auth.europe-west1.gcp.commercetools.com","baseUrl":"https://api.europe-west1.gcp.commercetools.com","project":"${COMMERCETOOLS_PROJECT_KEY}","password":"${COMMERCETOOLS_SECRET}","username":"${COMMERCETOOLS_CLIENT_ID}","enableLogging":true,"loggerFormatter":"full"}},"description":"","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"list-transformer","identifier":"commercetools-update-storage-category","name":"CommerceTools - Update Storage - Category","object":{"prototype":"data","parameters":{"filters":[],"transformers":[{"prototype":"storage-save-entity-in-storage","parameters":{"source":"id","storage":"commercetools-category-code-to-id","storageKey":"&{key}"}},{"prototype":"storage-save-entity-in-storage","parameters":{"storage":"commercetools-category-full-data","storageKey":"&{id}"}}]}},"description":"","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"storage","identifier":"commercetools-category-code-to-id","name":"CommerceTools - Category - Code to id","object":{"parameters":{"path":"commercetools-category-code-to-id-01JVPCRCY7DE473X5KYD13QFR1","logger":{"parameters":{"actions":[]}}}},"description":"Akeneo category code is mapped into Commercetools category id","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"storage","identifier":"commercetools-category-full-data","name":"CommerceTools - Category - Full data","object":{"parameters":{"path":"commercetools-category-full-data-01JVPF79SNXD0J105JT1EBAFRH","logger":{"parameters":{"actions":[]}}}},"description":"","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"route-configuration","identifier":"synchronize-categories-from-akeneo-into-commercetools","name":"Synchronize Categories - From Akeneo into CommerceTools","object":{"parameters":{"incoming":"akeneo-fetch-categories","outgoing":"commercetools-send-category","realtime":false,"transformers":[],"waitingStatus":false,"parallelExecution":[]}},"description":"","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"outgoing-configuration","identifier":"commercetools-send-category","name":"CommerceTools - Send - Category","object":{"parameters":{"publisher":{"prototype":"no-action-publisher","parameters":[]},"transformers":["alumio-base-convert-value-localization-localecode-into-commercetools-localecode","commercetools-prepare-convert-category-parent-from-alumio-base-category","commercetools-convert-category-from-alumio-base-category","commercetools-check-and-send-category"]}},"description":"The task that was created through Incoming **\"Akeneo - Fetch - Categories\"** will then processed further by the Route **\"Synchronize Categories - From Akeneo into CommerceTools\"** and will be send using this Outgoing.\n\nThis Outgoing will transform the Alumio Base Categories into CommerceTools one and check to create or to update category with the data from this outgoing previous iteration.","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"list-transformer","identifier":"alumio-base-convert-value-localization-localecode-into-commercetools-localecode","name":"Alumio Base - Convert value - Localization localeCode into CommerceTools localeCode","object":{"meta":[],"prototype":"node","parameters":{"accessor":{"prototype":"key","parameters":{"keys":[],"root":"localizations"}},"nodeFilters":[],"nodeTransformers":[{"meta":[],"prototype":"value-mapper","parameters":{"mappers":[{"prototype":"string-upper","parameters":[]},{"prototype":"string-replace","parameters":{"search":"_","replace":"-"}}],"accessor":{"prototype":"pattern","parameters":{"keys":[],"pattern":"localeCode"}}}}]}},"description":"This transformer will convert the localCode value inside localizations into localCode that Commercetools use.","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"list-transformer","identifier":"commercetools-prepare-convert-category-parent-from-alumio-base-category","name":"CommerceTools - Prepare convert - Category - Parent from Alumio Base Category","object":{"meta":[],"prototype":"data","parameters":{"filters":[],"transformers":[{"meta":[],"prototype":"conditional","parameters":{"filters":[{"prototype":"key-condition","parameters":{"filter":{"prototype":"key-exists-condition","parameters":{"path":"parent"}}}}],"elseCases":[],"transformers":[{"meta":[],"prototype":"conditional","parameters":{"filters":[{"prototype":"value-condition-v2","parameters":{"accessor":{"prototype":"pattern","parameters":{"keys":[],"pattern":"parent"}},"conditions":[{"prototype":"not-equals","parameters":{"value":null}},{"prototype":"not-equals","parameters":{"value":[]}}]}}],"elseCases":[],"transformers":[{"meta":[],"prototype":"pattern-move","parameters":{"pattern":"parent","conditions":[],"replacement":"parent.code"}},{"meta":[],"prototype":"value-setter","parameters":{"configurations":[{"key":"parent.typeId","value":"category","mappers":[]}]}},{"meta":[],"prototype":"storage-get-entity-from-storage","parameters":{"storage":"commercetools-category-code-to-id","storageKey":"&{parent.code}","destination":"parent.id"}},{"meta":[],"prototype":"value-remover","parameters":{"patterns":[{"key":"parent.code"}]}},{"meta":[],"prototype":"conditional","parameters":{"filters":[{"prototype":"key-condition","parameters":{"filter":{"prototype":"key-not-exists-condition","parameters":{"path":"parent.id"}}}}],"elseCases":[],"transformers":[{"meta":[],"prototype":"exception","parameters":{"message":"Category id not found for parent"}}],"elseTransformers":[]}}],"elseTransformers":[{"meta":[],"prototype":"value-remover","parameters":{"patterns":[{"key":"parent"}]}}]}}],"elseTransformers":[]}}]}},"description":"This transformer will check the parent and map into CommerceTools id.","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"list-transformer","identifier":"commercetools-convert-category-from-alumio-base-category","name":"CommerceTools - Convert - Category - from Alumio Base Category","object":{"meta":[],"prototype":"chain","parameters":{"transformers":[{"meta":[],"prototype":"data","parameters":{"filters":[],"transformers":[{"meta":[],"prototype":"pattern-move","parameters":{"pattern":"code","conditions":[],"replacement":"key"}},{"meta":[],"prototype":"value-setter","parameters":{"configurations":[{"key":"orderHint","value":"0.1","mappers":[]}]}},{"meta":[],"prototype":"recursively-copy-values-to-children","parameters":{"mergeTemplate":{"key":"&{key}"},"childrenPattern":"localizations.*"}}]}},{"meta":[],"prototype":"node","parameters":{"accessor":{"prototype":"pattern","parameters":{"keys":[],"pattern":"localizations.*"}},"nodeFilters":[],"nodeTransformers":[{"meta":[],"prototype":"value-setter","parameters":{"configurations":[{"key":"test1","value":"&{translation}","mappers":[{"prototype":"string-slugify","parameters":[]}]},{"key":"test2","value":"&{key}","mappers":[{"prototype":"string-slugify","parameters":[]}]},{"key":"test","value":"&{test1}-&{test2}","mappers":[]}]}},{"meta":[],"prototype":"value-setter","parameters":{"configurations":[{"key":"name.&{localeCode}","value":"&{translation}","mappers":[]}]}},{"meta":[],"prototype":"conditional","parameters":{"filters":[{"prototype":"value-condition-v2","parameters":{"accessor":{"prototype":"pattern","parameters":{"keys":[],"pattern":"test"}},"conditions":[{"prototype":"string-length-between","parameters":{"max":256,"min":2}}]}}],"elseCases":[],"transformers":[{"meta":[],"prototype":"value-setter","parameters":{"configurations":[{"key":"slug.&{localeCode}","value":"&{test}","mappers":[]}]}}],"elseTransformers":[{"meta":[],"prototype":"exception","parameters":{"message":"Slug must be between 2 to 256 characters."}}]}}]}},{"meta":[],"prototype":"data","parameters":{"filters":[],"transformers":[{"meta":[],"prototype":"pattern-move","parameters":{"pattern":"localizations.*.slug","conditions":[],"replacement":"slug.$1"}},{"meta":[],"prototype":"value-mapper","parameters":{"mappers":[{"prototype":"operator","parameters":{"operator":"array-merge"}}],"accessor":{"prototype":"pattern","parameters":{"keys":[],"pattern":"slug"}}}},{"meta":[],"prototype":"pattern-move","parameters":{"pattern":"localizations.*.name","conditions":[],"replacement":"name.$1"}},{"meta":[],"prototype":"value-mapper","parameters":{"mappers":[{"prototype":"operator","parameters":{"operator":"array-merge"}}],"accessor":{"prototype":"pattern","parameters":{"keys":[],"pattern":"name"}}}},{"meta":[],"prototype":"value-remover","parameters":{"patterns":[{"key":"localizations"}]}}]}}]}},"description":"This transformer will finally convert Category from Alumio Base into CommerceTools.","owner":null,"disabled":false}
{"$schema":"https://di.schema.alumio.com/register.configuration.json","type":"list-transformer","identifier":"commercetools-check-and-send-category","name":"CommerceTools - Check and send - Category","object":{"meta":[],"prototype":"data","parameters":{"filters":[],"transformers":[{"meta":[],"prototype":"storage-get-entity-from-storage","parameters":{"storage":"commercetools-category-code-to-id","storageKey":"&{key}","destination":"id"}},{"meta":[],"prototype":"conditional","parameters":{"filters":[{"prototype":"key-condition","parameters":{"filter":{"prototype":"key-not-exists-condition","parameters":{"path":"id"}}}}],"elseCases":[],"transformers":[{"meta":[],"prototype":"http-transformer","parameters":{"client":"commercetools-http-client","request":{"uri":"/categories","method":"POST","payload":"&{@}","plugins":[],"payloadType":"data","authentications":[]}}},{"meta":[],"prototype":"storage-save-entity-in-storage","parameters":{"source":"id","storage":"commercetools-category-code-to-id","storageKey":"&{key}"}},{"meta":[],"prototype":"storage-save-entity-in-storage","parameters":{"storage":"commercetools-category-full-data","storageKey":"&{id}"}}],"elseTransformers":[{"meta":[],"prototype":"value-setter","parameters":{"configurations":[{"key":"actions","value":[],"mappers":[]}]}},{"meta":[],"prototype":"storage-get-entity-from-storage","parameters":{"storage":"commercetools-category-full-data","storageKey":"&{id}","destination":"old"}},{"meta":[],"prototype":"conditional","parameters":{"filters":[{"prototype":"key-condition","parameters":{"filter":{"prototype":"key-exists-condition","parameters":{"path":"parent"}}}}],"elseCases":[],"transformers":[{"meta":[],"prototype":"value-setter","parameters":{"configurations":[{"key":"result","value":[],"mappers":[]}]}},{"meta":[],"prototype":"operator","parameters":{"left":"parent","right":"old.parent","operator":"array-diff","destination":"result"}},{"meta":[],"prototype":"conditional","parameters":{"filters":[{"prototype":"value-condition-v2","parameters":{"accessor":{"prototype":"pattern","parameters":{"keys":[],"pattern":"result"}},"conditions":[{"prototype":"equals","parameters":{"value":[]}}]}}],"elseCases":[],"transformers":[{"meta":[],"prototype":"operator","parameters":{"left":"old.parent","right":"parent","operator":"array-diff","destination":"result"}}],"elseTransformers":[]}},{"meta":[],"prototype":"conditional","parameters":{"filters":[{"prototype":"value-condition-v2","parameters":{"accessor":{"prototype":"pattern","parameters":{"keys":[],"pattern":"result"}},"conditions":[{"prototype":"not-equals","parameters":{"value":[]}}]}}],"elseCases":[],"transformers":[{"meta":[],"prototype":"value-setter","parameters":{"configurations":[{"key":"temp","value":[{"action":"changeParent","parent":"&{parent}"}],"mappers":[]}]}},{"meta":[],"prototype":"operator","parameters":{"left":"actions","right":"temp","operator":"array-merge"}}],"elseTransformers":[]}}],"elseTransformers":[]}},{"meta":[],"prototype":"conditional","parameters":{"filters":[{"prototype":"key-condition","parameters":{"filter":{"prototype":"key-exists-condition","parameters":{"path":"name"}}}}],"elseCases":[],"transformers":[{"meta":[],"prototype":"value-setter","parameters":{"configurations":[{"key":"result","value":[],"mappers":[]}]}},{"meta":[],"prototype":"operator","parameters":{"left":"name","right":"old.name","operator":"array-diff","destination":"result"}},{"meta":[],"prototype":"conditional","parameters":{"filters":[{"prototype":"value-condition-v2","parameters":{"accessor":{"prototype":"pattern","parameters":{"keys":[],"pattern":"result"}},"conditions":[{"prototype":"equals","parameters":{"value":[]}}]}}],"elseCases":[],"transformers":[{"meta":[],"prototype":"operator","parameters":{"left":"old.name","right":"name","operator":"array-diff","destination":"result"}}],"elseTransformers":[]}},{"meta":[],"prototype":"conditional","parameters":{"filters":[{"prototype":"value-condition-v2","parameters":{"accessor":{"prototype":"pattern","parameters":{"keys":[],"pattern":"result"}},"conditions":[{"prototype":"not-equals","parameters":{"value":[]}}]}}],"elseCases":[],"transformers":[{"meta":[],"prototype":"value-setter","parameters":{"configurations":[{"key":"temp","value":[{"name":"&{name}","action":"changeName"}],"mappers":[]}]}},{"meta":[],"prototype":"operator","parameters":{"left":"actions","right":"temp","operator":"array-merge"}}],"elseTransformers":[]}}],"elseTransformers":[]}},{"prototype":"conditional","parameters":{"filters":[{"prototype":"key-condition","parameters":{"filter":{"prototype":"key-exists-condition","parameters":{"path":"slug"}}}}],"elseCases":[],"transformers":[{"meta":[],"prototype":"value-setter","parameters":{"configurations":[{"key":"result","value":[],"mappers":[]}]}},{"meta":[],"prototype":"operator","parameters":{"left":"slug","right":"old.slug","operator":"array-diff","destination":"result"}},{"meta":[],"prototype":"conditional","parameters":{"filters":[{"prototype":"value-condition-v2","parameters":{"accessor":{"prototype":"pattern","parameters":{"keys":[],"pattern":"result"}},"conditions":[{"prototype":"equals","parameters":{"value":[]}}]}}],"elseCases":[],"transformers":[{"meta":[],"prototype":"operator","parameters":{"left":"old.slug","right":"slug","operator":"array-diff","destination":"result"}}],"elseTransformers":[]}},{"meta":[],"prototype":"conditional","parameters":{"filters":[{"prototype":"value-condition-v2","parameters":{"accessor":{"prototype":"pattern","parameters":{"keys":[],"pattern":"result"}},"conditions":[{"prototype":"not-equals","parameters":{"value":[]}}]}}],"elseCases":[],"transformers":[{"meta":[],"prototype":"value-setter","parameters":{"configurations":[{"key":"temp","value":[{"slug":"&{slug}","action":"changeSlug"}],"mappers":[]}]}},{"meta":[],"prototype":"operator","parameters":{"left":"actions","right":"temp","operator":"array-merge"}}],"elseTransformers":[]}}],"elseTransformers":[]}},{"meta":[],"prototype":"conditional","parameters":{"filters":[{"prototype":"value-condition-v2","parameters":{"accessor":{"prototype":"pattern","parameters":{"keys":[],"pattern":"actions"}},"conditions":[{"prototype":"not-equals","parameters":{"value":[]}}]}}],"elseCases":[],"transformers":[{"meta":[],"prototype":"http-transformer","parameters":{"client":"commercetools-http-client","request":{"uri":"/categories/&{id}","method":"POST","payload":{"actions":"&{actions}","version":"&{old.version}"},"plugins":[],"payloadType":"data","authentications":[]}}},{"meta":[],"prototype":"storage-save-entity-in-storage","parameters":{"storage":"commercetools-category-full-data","storageKey":"&{id}"}}],"elseTransformers":[]}}]}}]}},"description":"This transformer will check current CommerceTools id from previous iteration of this transformer to determine either we need to create or update the category in the CommerceTools System.","owner":null,"disabled":false}
